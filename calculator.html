<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Calculator</title>
  <style>
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "SF Pro Text",
        "Segoe UI", sans-serif;
    }

    body {
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      background: linear-gradient(135deg, 
        #1a1a2e 0%, 
        #16213e 25%, 
        #0f1419 50%, 
        #000000 100%);
      background-attachment: fixed;
      color: #fff;
      position: relative;
      overflow: hidden;
    }

    body::before {
      content: '';
      position: fixed;
      top: -50%;
      left: -50%;
      width: 200%;
      height: 200%;
      background: radial-gradient(circle at 30% 30%, 
        rgba(255, 159, 10, 0.1) 0%, 
        transparent 50%);
      animation: pulse 15s ease-in-out infinite;
      pointer-events: none;
    }

    @keyframes pulse {
      0%, 100% { opacity: 0.3; transform: scale(1); }
      50% { opacity: 0.5; transform: scale(1.1); }
    }

    .calculator {
      width: 320px;
      max-width: 95vw;
      border-radius: 36px;
      padding: 24px 20px 28px;
      background: linear-gradient(145deg, 
        rgba(30, 30, 30, 0.95) 0%, 
        rgba(15, 15, 15, 0.98) 50%,
        rgba(0, 0, 0, 1) 100%);
      backdrop-filter: blur(20px);
      box-shadow:
        0 32px 80px rgba(0, 0, 0, 0.95),
        0 16px 40px rgba(0, 0, 0, 0.8),
        0 0 0 1px rgba(255, 255, 255, 0.08),
        inset 0 1px 1px rgba(255, 255, 255, 0.1),
        0 0 60px rgba(255, 159, 10, 0.15);
      display: flex;
      flex-direction: column;
      gap: 20px;
      position: relative;
      z-index: 1;
      border: 1px solid rgba(255, 255, 255, 0.05);
    }

    .display {
      min-height: 88px;
      text-align: right;
      padding: 16px 18px;
      border-radius: 24px;
      background: linear-gradient(145deg, 
        rgba(20, 20, 20, 0.9) 0%, 
        rgba(10, 10, 10, 0.95) 100%);
      box-shadow: 
        inset 0 4px 12px rgba(0, 0, 0, 0.8),
        inset 0 0 0 1px rgba(255, 255, 255, 0.05),
        0 2px 8px rgba(0, 0, 0, 0.6),
        0 0 20px rgba(255, 159, 10, 0.08);
      display: flex;
      flex-direction: column;
      justify-content: center;
      gap: 6px;
      position: relative;
      overflow: hidden;
    }

    .display::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 1px;
      background: linear-gradient(90deg, 
        transparent, 
        rgba(255, 255, 255, 0.1), 
        transparent);
    }

    .display-history {
      font-size: 0.85rem;
      color: rgba(255, 255, 255, 0.55);
      min-height: 20px;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
      text-shadow: 0 1px 2px rgba(0, 0, 0, 0.5);
      font-weight: 400;
    }

    .display-main {
      font-size: 2.6rem;
      font-weight: 300;
      letter-spacing: 0.5px;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
      text-shadow: 0 2px 8px rgba(0, 0, 0, 0.8),
                   0 0 20px rgba(255, 255, 255, 0.1);
      line-height: 1.2;
      word-break: break-all;
      transition: font-size 0.2s ease, color 0.2s ease;
    }

    .display-main.error {
      font-size: 2rem;
      color: rgba(255, 120, 120, 1);
      text-shadow: 0 2px 8px rgba(255, 0, 0, 0.3),
                   0 0 20px rgba(255, 100, 100, 0.2);
    }

    .keypad {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 12px;
    }

    button {
      border: none;
      border-radius: 999px;
      padding: 16px 0;
      font-size: 1.3rem;
      font-weight: 500;
      cursor: pointer;
      transition:
        transform 0.08s cubic-bezier(0.4, 0, 0.2, 1),
        box-shadow 0.08s cubic-bezier(0.4, 0, 0.2, 1),
        background 0.15s cubic-bezier(0.4, 0, 0.2, 1),
        filter 0.15s ease-out;
      outline: none;
      user-select: none;
      position: relative;
      overflow: hidden;
    }

    button::before {
      content: '';
      position: absolute;
      top: 50%;
      left: 50%;
      width: 0;
      height: 0;
      border-radius: 50%;
      background: rgba(255, 255, 255, 0.2);
      transform: translate(-50%, -50%);
      transition: width 0.3s, height 0.3s;
    }

    button:active::before {
      width: 300px;
      height: 300px;
    }

    button:hover {
      transform: translateY(-2px);
      filter: brightness(1.1);
    }

    button:active {
      transform: translateY(0px) scale(0.96);
    }

    .btn-num {
      background: linear-gradient(145deg, 
        rgba(70, 70, 70, 0.95) 0%, 
        rgba(45, 45, 45, 0.98) 50%,
        rgba(30, 30, 30, 1) 100%);
      color: #ffffff;
      box-shadow: 
        0 8px 20px rgba(0, 0, 0, 0.6),
        0 4px 10px rgba(0, 0, 0, 0.4),
        inset 0 1px 0 rgba(255, 255, 255, 0.1),
        inset 0 -1px 0 rgba(0, 0, 0, 0.3);
      border: 1px solid rgba(255, 255, 255, 0.05);
    }

    .btn-num:hover {
      box-shadow: 
        0 12px 28px rgba(0, 0, 0, 0.7),
        0 6px 14px rgba(0, 0, 0, 0.5),
        inset 0 1px 0 rgba(255, 255, 255, 0.15),
        inset 0 -1px 0 rgba(0, 0, 0, 0.3);
    }

    .btn-num:active {
      background: linear-gradient(145deg, 
        rgba(55, 55, 55, 0.95) 0%, 
        rgba(35, 35, 35, 0.98) 50%,
        rgba(20, 20, 20, 1) 100%);
      box-shadow: 
        inset 0 4px 12px rgba(0, 0, 0, 0.6),
        inset 0 0 0 1px rgba(0, 0, 0, 0.3);
    }

    .btn-op {
      background: linear-gradient(145deg, 
        #ff9f0a 0%, 
        #ff8c00 50%,
        #ff7a00 100%);
      color: #ffffff;
      box-shadow: 
        0 8px 24px rgba(255, 159, 10, 0.5),
        0 4px 12px rgba(255, 159, 10, 0.3),
        inset 0 1px 0 rgba(255, 255, 255, 0.2),
        inset 0 -1px 0 rgba(0, 0, 0, 0.2);
      border: 1px solid rgba(255, 255, 255, 0.1);
      font-weight: 600;
    }

    .btn-op:hover {
      box-shadow: 
        0 12px 32px rgba(255, 159, 10, 0.6),
        0 6px 16px rgba(255, 159, 10, 0.4),
        inset 0 1px 0 rgba(255, 255, 255, 0.25),
        inset 0 -1px 0 rgba(0, 0, 0, 0.2);
    }

    .btn-op.active {
      background: linear-gradient(145deg, 
        #ffffff 0%, 
        #ffd54f 50%,
        #ff9f0a 100%);
      color: #000000;
      box-shadow: 
        0 8px 24px rgba(255, 255, 255, 0.4),
        0 4px 12px rgba(255, 159, 10, 0.5),
        inset 0 1px 0 rgba(255, 255, 255, 0.3),
        inset 0 -1px 0 rgba(0, 0, 0, 0.1);
    }

    .btn-func {
      background: linear-gradient(145deg, 
        rgba(90, 90, 90, 0.95) 0%, 
        rgba(60, 60, 60, 0.98) 50%,
        rgba(40, 40, 40, 1) 100%);
      color: #ffffff;
      box-shadow: 
        0 8px 20px rgba(0, 0, 0, 0.7),
        0 4px 10px rgba(0, 0, 0, 0.5),
        inset 0 1px 0 rgba(255, 255, 255, 0.1),
        inset 0 -1px 0 rgba(0, 0, 0, 0.3);
      border: 1px solid rgba(255, 255, 255, 0.05);
    }

    .btn-func:hover {
      box-shadow: 
        0 12px 28px rgba(0, 0, 0, 0.8),
        0 6px 14px rgba(0, 0, 0, 0.6),
        inset 0 1px 0 rgba(255, 255, 255, 0.15),
        inset 0 -1px 0 rgba(0, 0, 0, 0.3);
    }

    .btn-func:active {
      background: linear-gradient(145deg, 
        rgba(75, 75, 75, 0.95) 0%, 
        rgba(50, 50, 50, 0.98) 50%,
        rgba(30, 30, 30, 1) 100%);
      box-shadow: 
        inset 0 4px 12px rgba(0, 0, 0, 0.7),
        inset 0 0 0 1px rgba(0, 0, 0, 0.3);
    }

    .btn-zero {
      grid-column: span 2;
      text-align: left;
      padding-left: 28px;
    }

    .btn-equals {
      background: linear-gradient(145deg, 
        #ff9f0a 0%, 
        #ff8c00 50%,
        #ff7a00 100%);
      color: #ffffff;
      box-shadow: 
        0 8px 24px rgba(255, 159, 10, 0.5),
        0 4px 12px rgba(255, 159, 10, 0.3),
        inset 0 1px 0 rgba(255, 255, 255, 0.2),
        inset 0 -1px 0 rgba(0, 0, 0, 0.2);
      border: 1px solid rgba(255, 255, 255, 0.1);
      font-weight: 600;
    }

    .btn-equals:hover {
      box-shadow: 
        0 12px 32px rgba(255, 159, 10, 0.6),
        0 6px 16px rgba(255, 159, 10, 0.4),
        inset 0 1px 0 rgba(255, 255, 255, 0.25),
        inset 0 -1px 0 rgba(0, 0, 0, 0.2);
    }

    .btn-equals:active {
      background: linear-gradient(145deg, 
        #ff8c00 0%, 
        #ff7a00 50%,
        #ff6800 100%);
      box-shadow: 
        inset 0 4px 12px rgba(0, 0, 0, 0.4),
        inset 0 0 0 1px rgba(0, 0, 0, 0.2);
    }

    @media (max-width: 400px) {
      .calculator {
        border-radius: 28px;
        padding: 20px 16px 24px;
        gap: 18px;
      }

      .display {
        min-height: 80px;
        padding: 14px 16px;
        border-radius: 20px;
      }

      .display-main {
        font-size: 2.2rem;
      }

      .display-history {
        font-size: 0.75rem;
      }

      button {
        font-size: 1.15rem;
        padding: 14px 0;
      }

      .keypad {
        gap: 10px;
      }

      .btn-zero {
        padding-left: 24px;
      }
    }
  </style>
</head>
<body>
  <div class="calculator" role="application" aria-label="Calculator">
    <div class="display" aria-live="polite">
      <div class="display-history" id="history"></div>
      <div class="display-main" id="display">0</div>
    </div>

    <div class="keypad">
      <button class="btn-func" data-action="clear">C</button>
      <button class="btn-func" data-action="sign">±</button>
      <button class="btn-func" data-action="percent">%</button>
      <button class="btn-op" data-op="divide">÷</button>

      <button class="btn-num" data-num="7">7</button>
      <button class="btn-num" data-num="8">8</button>
      <button class="btn-num" data-num="9">9</button>
      <button class="btn-op" data-op="multiply">×</button>

      <button class="btn-num" data-num="4">4</button>
      <button class="btn-num" data-num="5">5</button>
      <button class="btn-num" data-num="6">6</button>
      <button class="btn-op" data-op="subtract">−</button>

      <button class="btn-num" data-num="1">1</button>
      <button class="btn-num" data-num="2">2</button>
      <button class="btn-num" data-num="3">3</button>
      <button class="btn-op" data-op="add">+</button>

      <button class="btn-num btn-zero" data-num="0">0</button>
      <button class="btn-num" data-num=".">.</button>
      <button class="btn-equals" data-action="equals">=</button>
    </div>
  </div>

  <script>
    (function () {
      const displayEl = document.getElementById("display");
      const historyEl = document.getElementById("history");
      const keypad = document.querySelector(".keypad");

      let current = "0";
      let previous = null;
      let operator = null;
      let justEvaluated = false;

      // Maximum safe integer in JavaScript (2^53 - 1)
      const MAX_SAFE_INTEGER = Number.MAX_SAFE_INTEGER;
      const MIN_SAFE_INTEGER = Number.MIN_SAFE_INTEGER;
      // Maximum value for display (we'll use a more conservative limit)
      const MAX_DISPLAY_VALUE = 1e15;
      const MIN_DISPLAY_VALUE = -1e15;

      function isNumberTooLarge(value) {
        const num = Number(value);
        if (!isFinite(num)) return true;
        const abs = Math.abs(num);
        return abs > MAX_DISPLAY_VALUE;
      }

      function isNumberSafe(value) {
        const num = Number(value);
        if (!isFinite(num)) return false;
        const abs = Math.abs(num);
        return abs <= MAX_SAFE_INTEGER;
      }

      function formatNumber(value) {
        if (value === "Infinity" || value === "-Infinity" || Number.isNaN(Number(value))) {
          return "Error";
        }

        // Check if value is too large for accurate display
        if (isNumberTooLarge(value)) {
          return "Too Large";
        }

        const num = Number(value);
        const abs = Math.abs(num);

        // Use exponential notation for very large or very small numbers
        if (abs !== 0 && (abs >= 1e10 || abs < 1e-6)) {
          return num.toExponential(6).replace(/\.?0+e/, "e");
        }

        // Check for precision loss in large integers
        if (abs > MAX_SAFE_INTEGER) {
          return "Too Large";
        }

        const str = num.toString();
        const [intPart, decPart] = str.split(".");

        // Handle integer part
        const intNum = Number(intPart);
        if (!isFinite(intNum) || Math.abs(intNum) > MAX_SAFE_INTEGER) {
          return "Too Large";
        }

        const intFormatted = intNum.toLocaleString("en-US");
        if (decPart === undefined) return intFormatted;

        return intFormatted + "." + decPart.slice(0, 8);
      }

      function updateDisplay() {
        const formatted = formatNumber(current);
        displayEl.textContent = formatted;
        
        // Add error class for error states
        if (formatted === "Error" || formatted === "Too Large") {
          displayEl.classList.add("error");
        } else {
          displayEl.classList.remove("error");
        }
      }

      function clearAll() {
        current = "0";
        previous = null;
        operator = null;
        justEvaluated = false;
        historyEl.textContent = "";
        setActiveOperator(null);
        updateDisplay();
      }

      function setActiveOperator(op) {
        document.querySelectorAll(".btn-op").forEach((btn) => {
          if (btn.dataset.op === op) {
            btn.classList.add("active");
          } else {
            btn.classList.remove("active");
          }
        });
      }

      function appendNumber(num) {
        // Don't allow input if current value is an error
        if (current === "Error" || current === "Too Large") {
          return;
        }

        if (justEvaluated && !operator) {
          current = num === "." ? "0." : num;
          justEvaluated = false;
          updateDisplay();
          return;
        }

        if (num === ".") {
          if (current.includes(".")) return;
          current += ".";
        } else {
          if (current === "0") {
            current = num;
          } else {
            // Check if adding this digit would make the number too large
            const testValue = current + num;
            const numValue = Number(testValue);
            
            // Prevent numbers that are already too large from getting larger
            if (isNumberTooLarge(testValue)) {
              return; // Silently ignore input that would exceed limits
            }
            
            current += num;
          }
        }
        justEvaluated = false;
        updateDisplay();
      }

      function chooseOperator(op) {
        if (current === "Error" || current === "Too Large") return;

        if (previous !== null && operator && !justEvaluated) {
          evaluate();
          // If evaluation resulted in error, don't proceed
          if (current === "Error" || current === "Too Large") {
            return;
          }
        } else {
          previous = current;
        }

        operator = op;
        historyEl.textContent = formatNumber(previous) + " " + symbolForOperator(op);
        justEvaluated = false;
        setActiveOperator(op);
        current = "0";
        updateDisplay();
      }

      function symbolForOperator(op) {
        switch (op) {
          case "add":
            return "+";
          case "subtract":
            return "−";
          case "multiply":
            return "×";
          case "divide":
            return "÷";
          default:
            return "";
        }
      }

      function evaluate() {
        if (operator === null || previous === null || justEvaluated) {
          return;
        }

        // Check if inputs are valid numbers
        if (current === "Error" || current === "Too Large" || 
            previous === "Error" || previous === "Too Large") {
          current = "Error";
          previous = null;
          operator = null;
          justEvaluated = true;
          setActiveOperator(null);
          updateDisplay();
          return;
        }

        const a = Number(previous);
        const b = Number(current);

        // Validate inputs are finite numbers
        if (!isFinite(a) || !isFinite(b)) {
          current = "Error";
          previous = null;
          operator = null;
          justEvaluated = true;
          setActiveOperator(null);
          updateDisplay();
          return;
        }

        let result;
        switch (operator) {
          case "add":
            // Check if addition would exceed safe limits
            if ((a > 0 && b > MAX_SAFE_INTEGER - a) || 
                (a < 0 && b < MIN_SAFE_INTEGER - a)) {
              result = "Too Large";
            } else {
              result = a + b;
            }
            break;
          case "subtract":
            // Check if subtraction would exceed safe limits
            if ((a > 0 && -b > MAX_SAFE_INTEGER - a) || 
                (a < 0 && -b < MIN_SAFE_INTEGER - a)) {
              result = "Too Large";
            } else {
              result = a - b;
            }
            break;
          case "multiply":
            // Check if multiplication would exceed safe limits before calculating
            const absA = Math.abs(a);
            const absB = Math.abs(b);
            // Check for potential overflow before multiplying
            if (absA > 1 && absB > 1) {
              // If either number is already too large, result will be too large
              if (absA > MAX_SAFE_INTEGER || absB > MAX_SAFE_INTEGER) {
                result = "Too Large";
              } else if (absB > MAX_SAFE_INTEGER / absA) {
                // Multiplication would exceed safe integer range
                result = "Too Large";
              } else {
                result = a * b;
                // Double-check the result after calculation
                if (!isFinite(result) || Math.abs(result) > MAX_DISPLAY_VALUE) {
                  result = "Too Large";
                }
              }
            } else {
              result = a * b;
            }
            break;
          case "divide":
            result = b === 0 ? "Infinity" : a / b;
            break;
          default:
            result = b;
        }

        // Validate result
        if (result === "Too Large" || !isFinite(result) || isNumberTooLarge(result)) {
          if (!isFinite(result)) {
            result = "Error";
          } else if (result !== "Too Large") {
            result = "Too Large";
          }
        } else {
          // Check for precision loss in the result
          if (isFinite(result) && !isNumberSafe(result) && result % 1 === 0) {
            // Integer result that lost precision
            result = "Too Large";
          }
        }

        historyEl.textContent =
          formatNumber(previous) + " " + symbolForOperator(operator) + " " + formatNumber(current) + " =";

        current = String(result);
        previous = null;
        operator = null;
        justEvaluated = true;
        setActiveOperator(null);
        updateDisplay();
      }

      function toggleSign() {
        if (current === "0" || current === "Error" || current === "Too Large") return;
        if (current.startsWith("-")) {
          current = current.slice(1);
        } else {
          current = "-" + current;
        }
        updateDisplay();
      }

      function toPercent() {
        if (current === "Error" || current === "Too Large") return;
        const result = Number(current) / 100;
        if (!isFinite(result) || isNumberTooLarge(result)) {
          current = "Too Large";
        } else {
          current = String(result);
        }
        updateDisplay();
      }

      keypad.addEventListener("click", (e) => {
        const target = e.target;
        if (!(target instanceof HTMLButtonElement)) return;

        const num = target.dataset.num;
        const op = target.dataset.op;
        const action = target.dataset.action;

        if (num !== undefined) {
          appendNumber(num);
          return;
        }

        if (op !== undefined) {
          chooseOperator(op);
          return;
        }

        if (action === "clear") {
          clearAll();
        } else if (action === "equals") {
          evaluate();
        } else if (action === "sign") {
          toggleSign();
        } else if (action === "percent") {
          toPercent();
        }
      });

      // Basic keyboard support
      window.addEventListener("keydown", (e) => {
        const key = e.key;

        if (/\d/.test(key)) {
          appendNumber(key);
        } else if (key === ".") {
          appendNumber(".");
        } else if (key === "+") {
          chooseOperator("add");
        } else if (key === "-") {
          chooseOperator("subtract");
        } else if (key === "*" || key === "x" || key === "X") {
          chooseOperator("multiply");
        } else if (key === "/") {
          chooseOperator("divide");
        } else if (key === "Enter" || key === "=") {
          e.preventDefault();
          evaluate();
        } else if (key.toLowerCase() === "c" || key === "Escape") {
          clearAll();
        }
      });

      // Initialize
      clearAll();
    })();
  </script>
</body>
</html>


